<!DOCTYPE html>
<html>
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	{% load static %}
	<title>MathOCR</title>
	<link rel="stylesheet" type="text/css" href="{% static 'calc/styles/main.css' %}" />
	<link rel="stylesheet" type="text/css" href="{% static 'calc/styles/croppie.css' %}" />
	<script src="{% static 'calc/scripts/jquery.js' %}" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/mobomo/sketch.js/master/lib/sketch.min.js" type="text/javascript"></script>
	<script src="{% static 'calc/scripts/numeric.js' %}" type="text/javascript"></script>
	<script src="{% static 'calc/scripts/roots.js' %}" type="text/javascript"></script>
	<script src="{% static 'calc/scripts/main.js' %}" type="text/javascript"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="icon" href="{% static 'calc/images/logo.png' %}">
</head>
<body>
    <div class="hidden-div">
        <canvas id="canvas-hidden"></canvas>
    </div>
	{% if messages %}
	<div class="message">
		{% for message in messages %}
			<li {% if message.tags %} class="{{message.tags}}"{% endif %}>{{message}}</li>
		{% endfor %}
	</div>
	{% endif %}
	<div class="header">
	<h1 class="head-icon"><img src="{% static 'calc/images/logo.png' %}" class="head-logo">Math<span class="head-ocr">OCR<div id="what"></div></span></h1>
    <div class="menu">
        <div class="camera-page"><a href="{% url 'calc:campage' %}"><i class="fa fa-camera" style="padding-right:5px"></i>camera</a></div>
        <div class="upload-page"><a href="{% url 'calc:uppage' %}"><i class="fa fa-upload" style="padding-right:5px"></i>upload</a></div>
        <div class="sketch-page active-page"><a href="{% url 'calc:skpage' %}"><i class="fa fa-pencil" style="padding-right:5px"></i>sketchpad</a></div>
    </div>    
</div>
<div class="sketchpadapp">
        <div id="canvas-boxes">
        </div>
        <div class="sketch-div">
            <canvas class="sketchpad" id="canvas"></canvas>
        </div>
        <div class="tools-div">
            <button id="btn-ctx" onclick="clearCanvas()">Clear</button>
            <button id="btn-ctx" onclick="toggleScroll()">Scroll</button>
            <button id="btn-ctx" onclick="findSketchResult()">Result</button>
        </div>
        <div id="sketch-result-div">
                <div id="res-close">close</div>
            <div class="answer-div"><div id="answer-header">Result</div>
                <div class="answer"></div>
            <div class="equation-div">
                <p id="equation-header">Equations</p>
            <ul class="equation-list"></ul>
        </div>
        <div id="more-btn" class="not-rotate"><i class= "fa fa-chevron-circle-down"></i></div>
        </div>
        </div>
</div>
	<div class="main">
		<div class="row choice-div">
			<div class="column-4 help-col">
				<button class="input-btn" data-value=1><i class="fa fa-camera-retro" style="margin-right:10px"></i>Solve</button>
			</div>
		</div>
		<div class="row help-div">
			<div class="column-4 help-col">
				<h1>Perform Calculations</h1>
			</div>
			<div class="column-4 help-col">
				<h1>Solve set of Equations</h1>
			</div>
			<div class="column-4 help-col">
				<h1>Find roots of polynomials</h1>
			</div>
		</div>
		<div class="row contact-div">
			<div class="column-6 feed-col">
				<h1>About Us</h1>
				<div class="aboutus">
                    This project is a collaboration between -
                    <ul class="creators">
                        <li><a href="https://github.com/">Akshat Dubey</a>, responsible for the development of the python backend.</li>
                        <li><a href="https://github.com/Janamejay1212">Janmejay Pandey</a>, responsible for the developement of the single page web application.</li>
                        <li><a href="">Saurabh Dwivedi</a>,  responsible for database management and neural network training</li>
                    </ul>
				</div>
			</div>
			<div class="column-6 feed-col">
				<h1>Feedback</h1>
				{% load widget_tweaks %}
				<form class="feed-form" action="{% url 'calc:feedback' %}" method="post">
					{% csrf_token %}
					{% render_field form.u_name placeholder='Name' %}
					{% render_field form.u_email placeholder='Email ID' %}
					{% render_field form.u_body placeholder='Message' %}
					<input type="submit" value="SUBMIT"/>
				</form>
			</div>
		</div>
	</div>
	<div class="footer">
		<div class="footer-left">Version 0.5.0 &nbsp;|&nbsp; <a class="link-new" href="{% url 'admin:index' %}">Admin Panel</a></div>
		<div class="footer-right"><a href="https://github.com/akshatdb/FinalYearProject"><i class="fa fa-github github-icon"></i></a></div>
	</div>
	<script>
            $('.change-box-btn').on('click', function () {
                pos = ($('.change-box-btn-circle').css('left') == '2px') ? '22px' : '2px';
                $('.change-box-btn-circle').animate({
                    'left': pos
                }, 500);
                $('.digits').fadeToggle();
                $('.numbers').fadeToggle();
            });
            $('#more-btn').on('click', function () {
                $(this).toggleClass('rotate').toggleClass('not-rotate');
                $('.equation-div').slideToggle();
            });
</script>
<script type="text/javascript">
    prev = [];
    waitState = 0;
    i = 0;
    var rev = {
        '1':'+',
        '2':'x'
    }
    function checkOverlap(oldBox, newBox)
    {
        SI = Math.max(0, Math.min(oldBox[2], newBox[2]) - Math.max(oldBox[0], newBox[0])) * Math.max(0, Math.min(oldBox[3], newBox[3]) - Math.max(oldBox[1], newBox[1]))
        SA = Math.abs(oldBox[1]-oldBox[3]) * Math.abs(oldBox[0] - oldBox[2]);
        SB = Math.abs(newBox[1]-newBox[3]) * Math.abs(newBox[0] - newBox[2]);
        SU = SA + SB - SI;
        IoU = SI / SU;
        if(IoU > 0 && IoU < 0.1)
            return 1;
        if(IoU > 0.5)
            return 2;
        return false
    }
    function findSketchResult()
    {
        $('#res-close').fadeIn();
        id = prev[1] + '-' + prev[2] + '-' +prev[3] + '-' +prev[4]; 
        if (prev[4] < 5)
            fontSize = 20;
        else
            fontSize = prev[4];
        $('#canvas-boxes').append('<div id="box-' + id + '" class="num-box" data-id=' + prev[0] + ' ></div>');
        $('#box-' + id).text(prev[0]);
        $('#box-' + id).css({
            'height': prev[4],
            'width': prev[3],
            'top': prev[2],
            'left': prev[1],
            'font-size': fontSize,
            'z-index': 2,
            'display':'none'
        });
        $('#box-' + id).fadeIn();
        i++;
        symlist.push([prev[1], prev[2], prev[3], prev[4], prev[0], Number(i), prev[0], [], '\0', 0]);    
        if(symlist.length > 0)
            evaluateList();
        //$('#sketch-result-div').slideUp();
        $('.answer-div').slideDown();
        $('#res-close').css({
            'position':'fixed.',
            'bottom':$('.answer-div').innerHeight()*0.6
        })
        $('#res-close').on('click',function(){
            $(this).fadeOut();
            $('#sketch-result-div').slideDown();
            $('.answer-div').slideUp();
            prev = [];
            waitState = 0;
        });
        $('#box-' + id).on('click', function () {
        val = prompt("Please enter correct value:");
        if(isValid(val))
        {

        }
        });
    }
    function failedResponse(error)
    {
        console.log(error);
    }
    function addResponse(data,x,y,w,h)
    {
        if(waitState==0){
            prev = [data['ans'], x, y, w, h];
            waitState = 1;
            return;
        }else{
            var checkBox = checkOverlap([prev[1],prev[2],prev[1]+prev[3],prev[2]+prev[4]], [x,y,x+w,y+h]);
            if (checkBox)
            {
                newBox = [rev[checkBox],0,0,0,0];
                newBox[1] = prev[1] < x ? prev[1]:x;
                newBox[2] = prev[2] < y ? prev[2]:y;
                newBox[3] = prev[3] > w ? prev[3]:w;
                newBox[4] = prev[4] > h ? prev[4]:h;
                id = newBox[1] + '-' + newBox[2] + '-' +newBox[3] + '-' +newBox[4]; 
                canvashid.height = newBox[4]+4;
                canvashid.width = newBox[3]+4;
                
                contexthid.drawImage(canvas,newBox[1]-2,newBox[2]-2,newBox[3]+2, newBox[4]+2, 0, 0,newBox[3]+4, newBox[4]+4);
                imgfile = canvashid.toDataURL('image/png');
                var blobBin = atob(imgfile.split(',')[1]);
                var array = [];
                for(var i = 0; i < blobBin.length; i++) {
                    array.push(blobBin.charCodeAt(i));
                }
                var file=new Blob([new Uint8Array(array)], {type: 'image/png'});
                var reqt = 0;
                var addr = "{% url 'calc:charapi' %}";
                var csrf = $('[name="csrfmiddlewaretoken"]').val()
                var upload = new Upload(file,addr,0,csrf);
                // maby check size or type here with upload.getSize() and upload.getType()
                // execute upload
                var formData = new FormData();
            
                // add assoc key values, this will be posts values
                formData.append("image", file, 'n.jpg');
                formData.append("csrfmiddlewaretoken", csrf);
                formData.append("req_type", reqt);
                $.ajax({
                    type: "POST",
                    url: addr,
                    success: function (data) {
                        // your callback here
                        if (newBox[4] < 5)
                            fontSize = 20;
                        else
                            fontSize = newBox[4];
                        $('#canvas-boxes').append('<div id="box-' + id + '" class="num-box" data-id=' + newBox['ans'] + ' ></div>');
                        $('#box-' + id).text(data['ans']);
                        $('#box-' + id).css({
                        'height': newBox[4],
                        'width': newBox[3],
                        'top': newBox[2],
                        'left': newBox[1],
                        'font-size': fontSize,
                        'z-index': 2,
                        'display':'none'
                        });
                        i++;
                        symlist.push([newBox[1], newBox[2], newBox[3], newBox[4], newBox[0], Number(i), newBox[0], [], '\0', 0]);
                        $('#box-' + id).fadeIn();
                        waitState = 0;
                        },
                        error: function (error) {
                            // handle error
                            failedResponse(error)
                        },
                        async: true,
                        data: formData,
                        cache: false,
                        dataType: 'json',
                        contentType: false,
                        processData: false,
                     timeout: 66000
                    });                            
            }
            else {
                id = prev[1] + '-' + prev[2] + '-' +prev[3] + '-' +prev[4]; 
                if (prev[4] < 5)
                    fontSize = 20;
                else
                    fontSize = prev[4];
                $('#canvas-boxes').append('<div id="box-' + id + '" class="num-box" data-id=' + prev[0] + ' ></div>');
                $('#box-' + id).text(prev[0]);
                $('#box-' + id).css({
                    'height': prev[4],
                    'width': prev[3],
                    'top': prev[2],
                    'left': prev[1],
                    'font-size': fontSize,
                    'z-index': 2,
                    'display':'none'
                });
                $('#box-' + id).fadeIn();
                i++;
                symlist.push([prev[1], prev[2], prev[3], prev[4], prev[0], Number(i), prev[0], [], '\0', 0]);
                prev = [data['ans'], x, y, w, h]
            }
        }
    }
    var minx,maxx,miny,maxy;
    canvas = document.getElementById('canvas');
    canvas.width = $(window).width();
    canvas.height = window.innerHeight;
    boxes = document.getElementById('canvas-boxes');
    boxes.width = $(window).width();
    boxes.height = window.innerHeight;
    context = canvas.getContext("2d");
    var canvashid = document.getElementById('canvas-hidden');
    var contexthid  = canvashid.getContext('2d');
    context.fillStyle = "white";
    context.fillRect(0, 0, canvas.width, canvas.height);
    $('#canvas').on('mousedown',function(e){
        var mouseX = e.pageX - this.offsetLeft;
        var mouseY = e.pageY - this.offsetTop;
              
        paint = true;
        maxx = e.pageX - this.offsetLeft;
        minx = e.pageX - this.offsetLeft;
        maxy = e.pageY - this.offsetTop;
        miny = e.pageY - this.offsetTop;
        addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
        redraw();
      });
      $('#canvas').on('mousemove',function(e){
        if(paint){
          if(e.pageX - this.offsetLeft > maxx)
            maxx = e.pageX - this.offsetLeft;
          if(e.pageX - this.offsetLeft < minx)
            minx = e.pageX - this.offsetLeft;
          if(e.pageY - this.offsetTop > maxy)
            maxy = e.pageY - this.offsetTop;
          if(e.pageY - this.offsetTop < miny)
            miny = e.pageY - this.offsetTop;
          addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
          redraw();
        }
      });
      $('#canvas').on('mouseup',function(e){
        paint = false;
        canvashid.height = maxy-miny+4;
        canvashid.width = maxx-minx+4;
        
        contexthid.drawImage(canvas,minx-2,miny-2,maxx-minx+2, maxy-miny+2, 0, 0,maxx-minx+4, maxy-miny+4);
        imgfile = canvashid.toDataURL('image/png');
        var blobBin = atob(imgfile.split(',')[1]);
        var array = [];
        for(var i = 0; i < blobBin.length; i++) {
            array.push(blobBin.charCodeAt(i));
        }
        var file=new Blob([new Uint8Array(array)], {type: 'image/png'});
        var reqt = 0;
        var addr = "{% url 'calc:charapi' %}";
        var csrf = $('[name="csrfmiddlewaretoken"]').val()
        var upload = new Upload(file,addr,0,csrf);
        // maby check size or type here with upload.getSize() and upload.getType()
        // execute upload
        var formData = new FormData();
    
        // add assoc key values, this will be posts values
        formData.append("image", file, 'n.jpg');
        formData.append("csrfmiddlewaretoken", csrf);
        formData.append("req_type", reqt);
        $.ajax({
            type: "POST",
            url: addr,
            success: function (data) {
                // your callback here
                addResponse(data, minx-2, miny-2, maxx-minx+2,maxy-miny+2);
            },
            error: function (error) {
                // handle error
                failedResponse(error)
            },
            async: true,
            data: formData,
            cache: false,
            dataType: 'json',
            contentType: false,
            processData: false,
            timeout: 66000
        });
      });
      $('#canvas').on('mouseleave', function(e){
        paint = false;
      });
      var clickX = new Array();
      var clickY = new Array();
      var clickDrag = new Array();
      var paint;
      
      function addClick(x, y, dragging)
      {
        clickX.push(x);
        clickY.push(y);
        clickDrag.push(dragging);
      }

      function clearCanvas(){
        context.clearRect(0, 0, context.canvas.width, context.canvas.height);
        clickX = new Array();
        clickY = new Array();
        clickDrag = new Array();
        context.fillStyle = "white";
        context.fillRect(0, 0, canvas.width, canvas.height);
        $('#canvas-boxes').html('');
        symlist = $.extend(true, [], []);
        setInitValues();
      }

      function redraw(){
        context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas
        context.fillStyle = "white";
        context.fillRect(0, 0, canvas.width, canvas.height); 
        context.strokeStyle = "#000000";
        context.lineJoin = "round";
        context.lineWidth = 5;
                  
        for(var i=0; i < clickX.length; i++) {		
          context.beginPath();
          if(clickDrag[i] && i){
            context.moveTo(clickX[i-1], clickY[i-1]);
           }else{
             context.moveTo(clickX[i]-1, clickY[i]);
           }
           context.lineTo(clickX[i], clickY[i]);
           context.closePath();
           context.stroke();
        }
      }
      var keys = {37: 1, 38: 1, 39: 1, 40: 1};

    // Stop scrolling on mobile
    function preventDefault(e) {
    e = e || window.event;
    if (e.preventDefault)
          e.preventDefault();
    e.returnValue = false;  
    }

    function preventDefaultForScrollKeys(e) {
        if (keys[e.keyCode]) {
            preventDefault(e);
            return false;
        }
    }

    function disableScroll() {
        if (window.addEventListener) // older FF
            window.addEventListener('DOMMouseScroll', preventDefault, false);
        window.onwheel = preventDefault; // modern standard
        window.onmousewheel = document.onmousewheel = preventDefault; // older browsers, IE
        window.ontouchmove  = preventDefault; // mobile
        document.onkeydown  = preventDefaultForScrollKeys;
    }

    function enableScroll() {
        if (window.removeEventListener)
            window.removeEventListener('DOMMouseScroll', preventDefault, false);
        window.onmousewheel = document.onmousewheel = null; 
        window.onwheel = null; 
        window.ontouchmove = null;  
        document.onkeydown = null;  
    }
    function getTouchPos(canvasDom, touchEvent) {
        var rect = canvasDom.getBoundingClientRect();
        return {
            x: touchEvent.touches[0].clientX - rect.left,
            y: touchEvent.touches[0].clientY - rect.top
        };
    }
    function handleTouchStart(e)
    {
        mousePos = getTouchPos(canvas, e);
        var touch = e.touches[0];
        var mouseEvent = new MouseEvent("mousedown", {
        clientX: touch.clientX,
        clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }
    function handleTouchEnd(e)
    {
        var mouseEvent = new MouseEvent("mouseup", {});
        canvas.dispatchEvent(mouseEvent);
    }
    function handleTouchMove(e)
    {
        var touch = e.touches[0];
        var mouseEvent = new MouseEvent("mousemove", {
        clientX: touch.clientX,
        clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }
    function initiateMobileTouch()
    {
        canvas.addEventListener("touchstart", handleTouchStart, false);
          canvas.addEventListener("touchend", handleTouchEnd, false);
          canvas.addEventListener("touchmove", handleTouchMove, false);
    }
    function disableMobileTouch()
    {
        canvas.removeEventListener('touchstart', handleTouchStart);
        canvas.removeEventListener('touchend', handleTouchEnd);
        canvas.removeEventListener('touchmove', handleTouchMove);
    }
    scrollFlag = 0;
    toggleScroll();
    function toggleScroll()
    {
        if(scrollFlag == 0)
        {
            disableScroll();
            initiateMobileTouch();
            $('.num-box').fadeIn();
            scrollFlag = 1;
        }
        else
        {
            enableScroll();
            disableMobileTouch();
            $('.num-box').fadeOut();
            scrollFlag = 0;
        }
    }
</script>
</body>
</html>
